import json
import logging
import sys
import urllib.parse
from tabulate import tabulate


class InspectorFinding:
    def __init__(self):
        self.package_names = []
        self.vulnerability_id = ""
        self.cvss_severity = ""
        self.cvss_score = ""
        self.installed_versions = []
        self.fixed_versions = []
        self.analysis_state = ""
        self.advisories = ""

    def to_dict(self):
        return {
            "Vulnerability ID": self.vulnerability_id,
            "CVSSv3 Severity": self.cvss_severity,
            "CVSSv3 Score": self.cvss_score,
            "Affected Packages": self.package_names,
            "Installed Versions": self.installed_versions,
            "Fixed Versions": self.fixed_versions
        }


def print_summarized_findings_as_table(summarized_findings):
    #sorted_findings = sorted(summarized_findings, key=lambda obj: obj.cvss_score, reverse=True)
    sorted_findings = summarized_findings

    header = ["Vulnerability ID", "CVSSv3 Severity", "Affected Packages", "Installed Versions", "Fixed Versions"]
    table = []
    for finding in sorted_findings:
        name_cell = "\n".join(finding.package_names)
        installed_ver_cell = "\n".join(finding.installed_versions)
        fixed_ver_cell = "\n".join(finding.fixed_versions)

        severity = f"{finding.cvss_severity} {finding.cvss_score}"
        row = [finding.vulnerability_id, severity, name_cell,
               installed_ver_cell, fixed_ver_cell]
        table.append(row)
    print(tabulate(table, headers=header, stralign="left", numalign="left"))
    return


def print_summarized_findings_as_json(summarized_findings):
    sorted_findings = sorted(summarized_findings, key=lambda obj: obj.cvss_score, reverse=True)

    for each_finding in sorted_findings:
        print(f"Vulnerability ID: {each_finding.vulnerability_id}")
        print(f"CVSSv3 Severity: {each_finding.cvss_severity}")
        print(f"CVSSv3 Score: {each_finding.cvss_score}")
        print(f"Analysis State: {each_finding.analysis_state}")

        names_str = ', '.join(each_finding.package_names)
        print(f"Affected Packages: {names_str}")

        # print(each_finding.installed_versions)
        # print(each_finding.fixed_versions)

        # print(each_finding.advisories)


def get_summarized_findings(inspector_scan_json):
    findings = get_findings(inspector_scan_json)
    vulnerabilities = get_vulnerabilities(findings)
    summarized_findings = []
    for vuln in vulnerabilities:
        finding = InspectorFinding()
        finding.cvss_severity, finding.cvss_score = get_cvss_severity(vuln)
        finding.vulnerability_id = get_vuln_id(vuln)
        finding.analysis_state = get_analysis_state(vuln)
        finding.advisories = get_advisories(vuln)

        affected_components = get_affected_components(vuln)
        for each_comp in affected_components:
            component = get_component(findings, each_comp)
            name, ver = get_component_name_version(component)
            finding.package_names.append(name)
            finding.installed_versions.append(ver)

            fixed_ver = get_fixed_version(vuln, each_comp)
            if fixed_ver is None or fixed_ver == "unknown":
                fixed_ver = ""
            finding.fixed_versions.append(fixed_ver)

            summarized_findings.append(finding)

    return summarized_findings


def get_findings(inspector_scan_json):
    findings = inspector_scan_json.get("sbom")
    if findings is None:
        logging.warning("expected 'sbom' json object but it was not found")
        sys.exit(1)
    return findings


def get_vulnerabilities(findings_json):
    vulnerabilities = findings_json.get("vulnerabilities")
    if vulnerabilities is None:
        logging.warning("expected 'vulnerabilities' json object but it was not found")
        sys.exit(1)
    return vulnerabilities


def get_cvss_severity(vuln_json):
    ratings = vuln_json.get("ratings")
    if ratings is None:
        logging.warning("expected 'ratings' json object but it was not found")
        sys.exit(1)

    for rating in ratings:
        method = rating.get("method")
        if method is None:
            logging.warning("expected 'method' json object but it was not found")
            sys.exit(1)

        if method != "CVSSv31":
            continue
        severity = rating.get("severity")
        if severity is None:
            logging.warning("expected value from key 'severity' but received none")
            sys.exit(1)

        score = rating.get("score")
        if score is None:
            logging.warning("expected value from key 'severity' but received none")
            sys.exit(1)

    return severity, score


def get_vuln_id(vuln_json):
    vuln_id = vuln_json.get("id")
    if vuln_id is None:
        logging.warning("expected value from key 'id' but received none")
        sys.exit(1)
    return vuln_id


def get_analysis_state(vuln_json):
    analysis = vuln_json.get("analysis")
    if analysis is None:
        logging.warning("expected json object from key 'analysis' but received none")
        sys.exit(1)

    analysis_state = analysis.get("state")
    if analysis_state is None:
        logging.warning("expected value from key 'state' but received none")
        sys.exit(1)

    return analysis_state


def get_advisories(vuln_json):
    advisories = vuln_json.get("advisories")
    if advisories is None:
        logging.warning("expected value from key 'advisories' but received none")
        sys.exit(1)

    advisory_urls = []
    for adv in advisories:
        url = adv["url"]
        advisory_urls.append(url)
    return advisory_urls


def get_affected_components(vuln_json):
    affects = vuln_json.get("affects")
    if affects is None:
        logging.warning("expected value from key 'affects' but received none")
        sys.exit(1)

    affected_components = []
    for each in affects:
        component = each.get("ref")
        if component is None:
            logging.warning("expected value from key 'ref' but received none")
            sys.exit(1)
        affected_components.append(component)

    return affected_components


def get_component(findings_json, bom_ref):
    components = findings_json.get("components")
    if components is None:
        logging.warning("expected value from key 'components' but received none")
        sys.exit(1)

    for comp in components:
        ref = comp.get("bom-ref")
        if ref is None:
            logging.warning("expected value from key 'bom-ref' but received none")
            sys.exit(1)

        if bom_ref == ref:
            return comp


def get_component_name_version(comp_json):
    name = comp_json.get("name")
    if name is None:
        logging.warning("expected value from key 'name' but received none")
        sys.exit(1)
    name = urllib.parse.unquote(name)
    version = comp_json.get("version")
    if version == "":
        version = "unknown"
    version = urllib.parse.unquote(version)
    return name, version


def get_fixed_version(vuln_json, bom_ref):
    properties = vuln_json.get("properties")
    if properties is None:
        return "unknown"

    prop_namespace = "amazon:inspector:sbom_scanner:fixed_version:"
    for prop in properties:
        name = prop.get("name")
        if not prop_namespace in name:
            continue

        if not bom_ref in name:
            continue

        fixed_version = prop.get("value")
        if fixed_version == "" or fixed_version is None:
            return "unknown"
        fixed_version = urllib.parse.unquote(fixed_version)
        return fixed_version
