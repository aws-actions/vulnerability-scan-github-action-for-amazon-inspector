# download inspector-sbomgen
# extract inspector-sbomgen package
# find the inspector-sbomgen binary in the package
# move the binary to the user's bin path
import logging
import os
import platform
import shutil
import sys
import tempfile

import downloader
import extractor
import finder


def get_sbomgen_url():
    cpu_arch = platform.machine()
    if cpu_arch == "x86_64":
        return "https://amazon-inspector-sbomgen.s3.amazonaws.com/latest/linux/amd64/inspector-sbomgen.zip"

    elif cpu_arch == "arm64":
        return "https://amazon-inspector-sbomgen.s3.amazonaws.com/latest/linux/arm64/inspector-sbomgen.zip"

    else:
        logging.error(f"expected cpu architecture to be either 'x86_64' or 'arm64' but received {cpu_arch}")
        sys.exit(1)


def install_sbomgen(install_path: str):
    sbomgen_url = get_sbomgen_url()

    path_to_sbomgen_zip = os.path.join(tempfile.gettempdir(), "inspector-sbomgen.zip")
    downloader.download_file(sbomgen_url, path_to_sbomgen_zip)

    path_to_extracted_sbomgen_dir = os.path.join(tempfile.gettempdir(), "inspector-sbomgen")
    extractor.extract_zip_file(path_to_sbomgen_zip, path_to_extracted_sbomgen_dir)

    sbomgen_path = finder.find_file_in_dir("inspector-sbomgen", path_to_extracted_sbomgen_dir)
    shutil.move(sbomgen_path, install_path)
    os.chmod(install_path, 0o500)  # read and execute permissions for owner

    os.system(f"{sbomgen_path} --version")
