import logging
import os
import platform
import shutil
import subprocess
import tempfile

import action_args
import downloader
import extractor
import finder


def get_sbomgen_url(os_name: str, cpu_arch: str) -> str:
    if os_name != "Linux":
        logging.error(f"expected OS to be Linux but received {os_name}")
        return ""

    if cpu_arch == "x86_64":
        return "https://amazon-inspector-sbomgen.s3.amazonaws.com/latest/linux/amd64/inspector-sbomgen.zip"

    elif cpu_arch == "arm64":
        return "https://amazon-inspector-sbomgen.s3.amazonaws.com/latest/linux/arm64/inspector-sbomgen.zip"

    else:
        logging.error(f"expected cpu architecture to be either 'x86_64' or 'arm64' but received {cpu_arch}")
        return ""


def install_sbomgen(install_path: str) -> bool:
    logging.info("getting the inspector-sbomgen url")
    sbomgen_url = get_sbomgen_url(platform.system(), platform.machine())
    if sbomgen_url == "":
        return False

    path_to_sbomgen_zip = os.path.join(tempfile.gettempdir(), "inspector-sbomgen.zip")

    logging.info(f"downloading inspector-sbomgen to {path_to_sbomgen_zip}")
    result = downloader.download_file(sbomgen_url, path_to_sbomgen_zip)
    if not result:
        return False

    path_to_extracted_sbomgen_dir = os.path.join(tempfile.gettempdir(), "inspector-sbomgen")

    logging.info(f"extracting inspector-sbomgen.zip to {path_to_extracted_sbomgen_dir}")
    result = extractor.extract_zip_file(path_to_sbomgen_zip, path_to_extracted_sbomgen_dir)
    if not result:
        return False

    logging.info(f"looking for inspector-sbomgen binary in {path_to_extracted_sbomgen_dir}")
    sbomgen_path = finder.find_file_in_dir("inspector-sbomgen", path_to_extracted_sbomgen_dir)
    if sbomgen_path == "":
        return False

    try:
        logging.info(f"moving '{sbomgen_path}' to '{install_path}'")
        shutil.move(sbomgen_path, install_path)

        logging.info(f"changing '{install_path}' permissions to read-execute for current user")
        os.chmod(install_path, 0o500)  # read and execute permissions for owner

        logging.info("validating installation")
        command = ["inspector-sbomgen", "--version"]
        output = subprocess.run(command, capture_output=True, text=True)
        if output.returncode != 0:
            logging.error(output.stderr)
            return False
        else:
            logging.info(f"installation succeeded for inspector-sbomgen v{output.stdout}")

    except Exception as e:
        logging.error(e)
        return False


def get_path_argument() -> str:
    path_arg = ""
    if action_args.ARTIFACT_TYPE.lower() == "repository":
        action_args.ARTIFACT_TYPE = "directory"
        return "--path"

    elif action_args.ARTIFACT_TYPE.lower() == "binary":
        return "--path"

    elif action_args.ARTIFACT_TYPE.lower() == "archive":
        return "--path"

    elif action_args.ARTIFACT_TYPE.lower() == "container":
        return "--image"

    else:
        logging.error(
            f"expected artifact type to be 'repository', 'container', 'archive', or 'binary', but received {action_args.ARTIFACT_TYPE}")


def execute_sbomgen(sbomgen_path):
    path_arg = get_path_argument()
    logging.info("executing inspector-sbomgen to create software bill of materials from provided artifact")
    cmd = f"{sbomgen_path} {action_args.ARTIFACT_TYPE} {path_arg} {action_args.ARTIFACT_PATH} --disable-progress-bar -o {action_args.OUTPUT_SBOM_PATH}"
    os.system(cmd)
    logging.info(f"sbom written to {action_args.OUTPUT_SBOM_PATH}")
    os.chmod(action_args.OUTPUT_SBOM_PATH, 0o777)


def invoke_inspector_scan():
    logging.info(f"sending {action_args.OUTPUT_SBOM_PATH} to Amazon Inspector for vulnerability scan")
    cmd = f"aws inspector-scan scan-sbom --sbom file://{action_args.OUTPUT_SBOM_PATH} --output-format CYCLONE_DX_1_5 > {action_args.OUTPUT_INSPECTOR_SCAN_PATH} 2>&1"
    os.system(cmd)
    logging.info(f"Inspector scan written to {action_args.OUTPUT_INSPECTOR_SCAN_PATH}")
    os.chmod(action_args.OUTPUT_INSPECTOR_SCAN_PATH, 0o777)
