#!/usr/bin/env python3
import logging
import sys

import action_args
import orchestrator
import thresholds


def main():
    action_args.init_cli_args(sys.argv)
    sbomgen_path = "/usr/local/bin/inspector-sbomgen"

    logging.info("downloading and installing the Amazon Inspector SBOM Generator (inspector-sbomgen)")
    print("--------------------------------------------------------------")
    orchestrator.install_sbomgen(sbomgen_path)

    logging.info("executing inspector-sbomgen to create software bill of materials from provided artifact")
    print("--------------------------------------------------------------")
    orchestrator.execute_sbomgen(sbomgen_path)

    logging.info("scanning SBOM contents for vulnerabilities with Amazon Inspector")
    print("--------------------------------------------------------------")
    orchestrator.invoke_inspector_scan()
    thresholds.check_vuln_thresholds(action_args.OUTPUT_INSPECTOR_SCAN_PATH,
                                     action_args.OUTPUT_SBOM_PATH,
                                     action_args.THRESHOLDS_ENABLED,
                                     action_args.CRITICAL_THRESHOLD,
                                     action_args.HIGH_THRESHOLD,
                                     action_args.MEDIUM_THRESHOLD,
                                     action_args.LOW_THRESHOLD)


if __name__ == "__main__":
    logging.basicConfig(level=logging.DEBUG)
    main()
