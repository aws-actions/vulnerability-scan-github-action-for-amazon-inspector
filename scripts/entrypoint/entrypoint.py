#!/usr/bin/env python3
import logging
import sys

import action_args
import log_formatter
import orchestrator
import thresholds


def main():
    action_args.init_cli_args(sys.argv)
    sbomgen_path = "/usr/local/bin/inspector-sbomgen"

    logging.info("downloading and installing the Amazon Inspector SBOM Generator (inspector-sbomgen)")
    orchestrator.install_sbomgen(sbomgen_path)

    logging.info("executing inspector-sbomgen to create software bill of materials from provided artifact")
    orchestrator.execute_sbomgen(sbomgen_path)

    logging.info("scanning SBOM contents for vulnerabilities with Amazon Inspector")
    orchestrator.invoke_inspector_scan()
    thresholds.check_vuln_thresholds(action_args.OUTPUT_INSPECTOR_SCAN_PATH,
                                     action_args.OUTPUT_SBOM_PATH,
                                     action_args.THRESHOLDS_ENABLED,
                                     action_args.CRITICAL_THRESHOLD,
                                     action_args.HIGH_THRESHOLD,
                                     action_args.MEDIUM_THRESHOLD,
                                     action_args.LOW_THRESHOLD)


if __name__ == "__main__":
    logger = logging.getLogger()
    logger.setLevel(logging.INFO)
    handler = logging.StreamHandler()
    handler.setLevel(logging.INFO)
    formatter = log_formatter.CustomFormatter()
    handler.setFormatter(formatter)
    logger.addHandler(handler)
    logger.info("this is a test")
    main()
