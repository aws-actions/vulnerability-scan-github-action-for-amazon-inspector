import os
import unittest

from collections import namedtuple

from entrypoint import dockerfile
from entrypoint import orchestrator


class TestOrchestrator(unittest.TestCase):

    def test_get_vuln_counts(self):
        # verify we can successfully parse all known-valid Inspector scans
        test_dir = "tests/test_data/scans/"
        file_list = os.listdir(test_dir)
        for file in file_list:
            path = os.path.join(test_dir, file)
            succeeded = orchestrator.get_vuln_counts(path)
            self.assertTrue(succeeded)

        # verify our vuln counts are correct
        succeeded, total, criticals, highs, mediums, lows, others = orchestrator.get_vuln_counts(
            "tests/test_data/scans/alpine:3.18.2.json.scan")
        self.assertTrue(succeeded)
        self.assertEqual(criticals, 1)
        self.assertEqual(highs, 1)
        self.assertEqual(mediums, 7)
        self.assertEqual(lows, 0)
        self.assertEqual(others, 3)
        self.assertEqual(total, criticals + highs + mediums + lows + others)

    def test_get_summarized_findings(self):
        criticals = highs = mediums = lows = others = 10
        total = criticals + highs + mediums + lows + others
        findings = orchestrator.get_summarized_findings("container", "alpine:3.18.2",
                                                        total, criticals, highs,
                                                        mediums, lows, others)
        print(findings)

    def test_thresholds(self):
        criticals = highs = mediums = lows = others = 10
        threshold_exceeded = orchestrator.exceeds_threshold(criticals, 1,
                                                            highs, 1,
                                                            mediums, 1,
                                                            lows, 1,
                                                            others, 1)
        self.assertTrue(threshold_exceeded)

        criticals = highs = mediums = lows = others = 0
        threshold_exceeded = orchestrator.exceeds_threshold(criticals, 0,
                                                            highs, 0,
                                                            mediums, 0,
                                                            lows, 0,
                                                            others, 0)
        self.assertFalse(threshold_exceeded)

    def test_inspector_scan(self):
        src = "tests/test_data/sboms/alpine:3.18.2.json"
        dst = "/tmp/inspector_scan_alpine.3.18.2.json"
        ret = orchestrator.invoke_inspector_scan(src, dst)
        self.assertEqual(ret, 0)

    def test_write_pkg_vuln_report_csv(self):
        ArgMock = namedtuple('args', ['out_scan', 'artifact_path', 'artifact_type', 'out_scan_csv'])
        args = ArgMock(out_scan="tests/test_data/artifacts/containers/dockerfile_checks/inspector-scan-cdx.json",
                       artifact_path="/mock/path/alpine.tar",
                       artifact_type="container",
                       out_scan_csv="/tmp/out_scan.csv"
                       )
        orchestrator.write_pkg_vuln_report_csv(args, 1, 2, 3, 4, 5)
        return

    def test_write_markdown_to_disk(self):
        ArgMock = namedtuple('args', ['out_scan', 'artifact_path', 'artifact_type', 'out_scan_markdown'])
        args = ArgMock(out_scan="tests/test_data/artifacts/containers/dockerfile_checks/inspector-scan-cdx.json",
                       artifact_path="/mock/path/alpine.tar",
                       artifact_type="container",
                       out_scan_markdown="/tmp/out_scan.md"
                       )
        orchestrator.write_pkg_vuln_report_markdown(args, 5, 1, 1, 1, 1, 1)
        return

    def test_system_against_dockerfile_findings(self):
        test_files = [
            "tests/test_data/artifacts/containers/dockerfile_checks/inspector-scan-cdx.json",
            "tests/test_data/artifacts/containers/dockerfile_checks/inspector-scan-cdx-no-components.json",
            "tests/test_data/artifacts/containers/dockerfile_checks/inspector-scan-cdx-no-vulns.json",
            "tests/test_data/artifacts/containers/dockerfile_checks/inspector-scan-cdx-dockerfile-only.json",
        ]

        for test_file in test_files:
            ArgMock = namedtuple('args', ['out_scan', 'artifact_path', 'artifact_type', 'out_scan_csv'])
            args = ArgMock(out_scan=test_file,
                           artifact_path=test_file,
                           artifact_type="container",
                           out_scan_csv="/tmp/out_scan.csv"
                           )

            succeeded, total_vulns, criticals, highs, mediums, lows, others = orchestrator.get_vuln_counts(test_file)
            self.assertTrue(succeeded)

            orchestrator.write_pkg_vuln_report_csv(args, criticals, highs, mediums, lows, others)


"""
        

        pkg_vuln_markdown = orchestrator.write_pkg_vuln_report_markdown(args, total_vulns, criticals, highs, mediums,
                                                                        lows, others)

        dockerfile.write_dockerfile_report_csv(args.out_scan, args.out_dockerfile_scan_csv)

        dockerfile.write_dockerfile_report_md(args.out_scan, args.out_dockerfile_scan_md)
"""


def read_test_file(file: str) -> str:
    file_contents = ""
    with open(file, "r") as f:
        file_contents = f.read()
    return file_contents


if __name__ == "__main__":
    unittest.main()
