import json
import os
import unittest

from entrypoint import inspector_scan_converter


class TestCSV(unittest.TestCase):

    def test_json_to_csv(self):
        test_dir = "tests/test_data/scans/"
        file_list = os.listdir(test_dir)
        for file in file_list:
            path = os.path.join(test_dir, file)

            inspector_scan_json = {}
            with open(path, 'r') as f:
                inspector_scan_json = json.load(f)

            vulns = inspector_scan_converter.vulns_to_obj(inspector_scan_json)
            if vulns == None:
                continue

            for v in vulns:
                self.assertTrue(["Vulnerability ID"] != "")
                self.assertTrue(v["Severity"] != "")
                self.assertTrue(v["Published"] != "")
                self.assertTrue(v["Modified"] != "")
                self.assertTrue(v["Description"] != "")
                self.assertTrue(v["Package Installed Version"] != "")
                self.assertTrue(v["Package Fixed Version"] != "")
                self.assertTrue(v["Package Path"] != "")
                self.assertTrue(v["EPSS Score"] != "")
                self.assertTrue(v["Exploit Available"] != "")
                self.assertTrue(v["Exploit Last Seen"] != "")
                self.assertTrue(v["CWEs"] != "")

            as_csv = inspector_scan_converter.to_csv(vulns)
            self.assertIsNotNone(as_csv)
            self.assertTrue(as_csv != "")

            f = open("/tmp/csv", "w")
            f.write(as_csv)
            f.close()
            print("")


if __name__ == "__main__":
    unittest.main()
